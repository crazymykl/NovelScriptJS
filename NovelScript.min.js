var NovelScript=function(){var t={setSlides:function(t){this.slides=t?"[object Array]"===Object.prototype.toString.call(t)?t:[]:[]},setActors:function(t){this.actors=t?"[object String]"===Object.prototype.toString.call(t)?[t]:"[object Array]"===Object.prototype.toString.call(t)?t:[]:[]},addActors:function(t){if(t){if("[object String]"===Object.prototype.toString.call(t)&&this.actors.push(t),"[object Array]"===Object.prototype.toString.call(t))for(var e=0;t.length>e;e++)this.actors.push(t[e]);if("[object Object]"===Object.prototype.toString.call(t))for(actor in t)this.actors.push(t[actor])}},getBackground:function(){return this.background},setText:function(t){"[object String]"===Object.prototype.toString.call(t)&&(this.text=t)},getText:function(){return this.text},setBackground:function(t){"[object String]"===Object.prototype.toString.call(t)&&(this.background=t)},defaultDraw:function(){this.context.fillStyle="#FFFFFF",this.context.fillRect(0,0,this.width,this.height),this.drawBackground(),this.drawActors(),this.drawText()},startStory:function(){this.canvas.style.display="block"},drawBackground:function(){this.background=this.background?this.background:"#FFFFFF",0==this.background.indexOf("#")?(this.context.fillStyle=this.background,this.context.fillRect(0,0,this.width,this.height)):this.context.drawImage(document.getElementById(this.background),0,0,this.width,this.height)},drawActors:function(){for(var t=this.height*this.goldenRatio/(this.goldenRatio+1),e=this.context,i=this.height/2,o=0;this.actors.length>o;o++){var r=document.getElementById(this.actors[o]),s=r.height,n=r.width;if(!this.noResize){if(s>t){var a=t/s;s=t,n=a*n}if(n>.3*this.width){var a=.3*this.width/n;s=a*s,n=.3*this.width}}e.save(),e.translate(this.width*((2*o+1)/(2*this.actors.length))-n/2,i-s/2),e.drawImage(r,0,0,n,s),e.restore()}},drawText:function(){this.textBaseline="top",this.context.save(),this.context.translate(0,this.goldenRatio*this.height/(this.goldenRatio+1));var t=this.height-this.goldenRatio*this.height/(this.goldenRatio+1),e=this.context.createLinearGradient(0,0,0,t);e.addColorStop(0,"rgba(142,214,255,.7)"),e.addColorStop(1,"rgba(0,76,179,.7)"),this.context.rect(4,4,this.width-8,t-8),this.context.fillStyle=e,this.context.fill(),this.context.strokeStyle="#000000",this.context.stroke(),this.context.fillStyle="#FFFFFF",this.context.font=""+this.fontSize+"pt "+this.font,this.drawRawText(this.text,8,this.fontSize+8,this.width-16,this.height-this.goldenRatio*this.height/(this.goldenRatio+1)-8),this.context.restore()},nextSlide:function(){var t=this.slides.shift();return t?("function"==typeof t&&(t(this),this.preventDefaultDraw||this.defaultDraw()),"object"==typeof t&&(t.text?this.setText(t.text):"",t.background?this.setBackground(t.background):"",t.actors&&this.setActors(t.actors),"function"==typeof t.code&&t.code(this)),this.history.push(t),!0):!1},drawRawText:function(t,e,i,o,r){var s;if(s="[object String]"===Object.prototype.toString.call(t)?t.split(/ /):t,!(r>=i+this.fontSize))return s;for(var n="";s.length&&o>this.context.measureText((n?n+" ":"")+s[0]).width;)n=(n?n+" ":"")+s.shift();this.context.fillText(n,e,i),s.length&&this.drawRawText(s,e,i+this.fontSize+4,o,r)}},e={fontSize:20,width:800,height:600,slides:[],variables:{},actors:[],background:"#EEEEEE",text:"",preventDefaultDraw:!1,font:"Palatino Linotype",noResize:!1},i=function(i){if(!i)throw Error("Options not defined.","NovelScript.js");if(this.fontSize=i.fontSize&&"[object String]"===Object.prototype.toString.call(i.fontSize)?i.fontSize:e.fontSize,this.history=[],this.goldenRatio=1.618,this.noResize=i.noResize&&"[object Boolean]"===Object.prototype.toString.call(i.noResize)?i.noResize:e.noResize,!i.target||"[object String]"!==Object.prototype.toString.call(i.target))throw Error("Options.target not defined.","NovelScript.js");this.target=i.target;var o=document.createDocumentFragment(),r=document.createElement("canvas"),s=r.getContext("2d");if(this.canvas=r,r.style.display="none",this.context=s,this.width=i.width&&"[object Number]"===Object.prototype.toString.call(i.width)?i.width:e.width,r.width=this.width,this.height=i.height&&"[object Number]"===Object.prototype.toString.call(i.height)?i.height:e.height,r.height=this.height,this.slides=i.slides&&"[object Array]"===Object.prototype.toString.call(i.slides)?i.slides:e.slides,this.setSlides=t.setSlides.bind(this),this.variables=i.variables&&"[object Object]"===Object.prototype.toString.call(i.variables)?i.variables:e.variables,i.images){var n=0,a="images"+(new Date).getTime(),h=function(){n--,n||i.onload&&"function"==typeof i.onload&&i.onload(this)}.bind(this),c=document.createDocumentFragment(),d=i.images;switch(Object.prototype.toString.call(d)){case"[object Object]":var l=0;for(image in d){var g=document.createElement("img");g.src=d[image],g.id=image,g.onload=h,c.appendChild(g),l++}n=l;break;case"[object Array]":n=d.length;for(var l=0;d.length>l;l++){var g=document.createElement("img");g.src=d[l],g.id=l,g.onload=h,c.appendChild(g)}break;case"[object String]":var b=document.getElementById(d).getElementsByTagName("img");for(n=b.length;b.length;)b[0].src=b[0].src+"?"+(new Date).getTime(),b[0].onload=h,c.appendChild(b[0]);break;default:throw Error("Unable to parse images.","NovelScript.js")}var p=document.createElement("span");p.style.display="none",this.ImageRepoID=a,p.id=a,p.appendChild(c),o.appendChild(r),o.appendChild(p),document.getElementById(this.target).appendChild(o)}this.actors=i.actors&&"[object Array]"===Object.prototype.toString.call(i.actors)?i.actors:e.actors,this.setActors=t.setActors.bind(this),this.addActors=t.addActors.bind(this),this.background=i.background&&"[object String]"===Object.prototype.toString.call(i.background)?i.background:e.background,this.setBackground=t.setBackground.bind(this),this.getBackground=t.getBackground.bind(this),this.text=i.text&&"[object String]"===Object.prototype.toString.call(i.text)?i.text:e.text,this.setText=t.setText.bind(this),this.getText=t.getText.bind(this),this.startStory=t.startStory.bind(this),this.drawBackground=t.drawBackground.bind(this),this.drawActors=t.drawActors.bind(this),this.drawText=t.drawText.bind(this),this.preventDefaultDraw=i.preventDefaultDraw&&"[object Boolean]"===Object.prototype.toString.call(i.preventDefaultDraw)?i.preventDefaultDraw:e.preventDefaultDraw,this.defaultDraw=t.defaultDraw.bind(this),this.nextSlide=t.nextSlide.bind(this),this.font=i.font&&"[object String]"===Object.prototype.toString.call(i.font)?i.font:e.font,this.drawRawText=t.drawRawText.bind(this)},o={NovelCanvas:i};return o}();